---
import ThemeToggle from "./ThemeToggle.astro";

const links = [
  { href: "#top", label: "Inicio" },
  { href: "#experiencia", label: "Experiencia" },
  { href: "#proyectos", label: "Proyectos" },
  { href: "#tecnologias", label: "Tecnologías" },
];
---

<header
  class="fixed top-0 z-10 flex items-center justify-center w-full mx-auto mt-2"
>
  <nav
    class="relative flex flex-row items-center gap-x-10 opacity-90 text-black dark:text-white px-4"
  >
    <!-- Botón hamburguesa (solo móvil) -->
    <button
      id="mobile-menu-button"
      type="button"
      class="sm:hidden relative inline-flex items-center justify-center rounded-md p-2 hover:opacity-70 transition"
      aria-expanded="false"
      aria-label="Abrir menú principal"
    >
      <span class="sr-only">Abrir menú principal</span>
      <!-- Icono menú -->
      <svg
        class="menu-icon size-6"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="1.5"
      >
        <path
          d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5"
          stroke-linecap="round"
          stroke-linejoin="round"></path>
      </svg>
      <!-- Icono cerrar -->
      <svg
        class="close-icon size-6 hidden"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="1.5"
      >
        <path
          d="M6 18 18 6M6 6l12 12"
          stroke-linecap="round"
          stroke-linejoin="round"></path>
      </svg>
    </button>

    <!-- Menú desktop -->
    <div class="hidden sm:flex sm:flex-row sm:gap-x-10">
      {
        links.map((link) => (
          <a
            class="hover:text-[#27EEF5] opacity-80 dark:hover:text-[rgb(14,165,233)] transition-colors"
            href={link.href}
            aria-label={`Ir a la sección ${link.label}`}
          >
            {link.label}
          </a>
        ))
      }
    </div>

    <ThemeToggle />

    <!-- Menú móvil desplegable -->
    <!-- Menú móvil desplegable -->
    <div
      id="mobile-menu"
      class="hidden sm:hidden absolute top-14 left-4 right-4 rounded-lg bg-white dark:bg-gray-800 shadow-lg backdrop-blur-md overflow-hidden"
    >
      <div class="space-y-1 px-4 py-4">
        {
          links.map((link) => (
            <a
              class="mobile-menu-link block rounded-md py-2 text-sm font-medium hover:text-[#27EEF5] dark:hover:text-[rgb(14,165,233)] transition-colors opacity-80 whitespace-nowrap"
              href={link.href}
              aria-label={`Ir a la sección ${link.label}`}
            >
              {link.label}
            </a>
          ))
        }
      </div>
    </div>
  </nav>
</header>

<script>
  function initMobileMenu() {
    const menuButton = document.getElementById("mobile-menu-button");
    const mobileMenu = document.getElementById("mobile-menu");
    const menuIcon = document.querySelector(".menu-icon");
    const closeIcon = document.querySelector(".close-icon");
    const mobileLinks = document.querySelectorAll(".mobile-menu-link");

    if (!menuButton || !mobileMenu) {
      console.log("Elementos del menú no encontrados");
      return;
    }

    // Toggle del menú móvil
    menuButton.addEventListener("click", (e) => {
      e.stopPropagation();
      const isExpanded = menuButton.getAttribute("aria-expanded") === "true";

      menuButton.setAttribute("aria-expanded", (!isExpanded).toString());
      mobileMenu.classList.toggle("hidden");
      menuIcon?.classList.toggle("hidden");
      closeIcon?.classList.toggle("hidden");
    });

    // Cerrar menú al hacer clic en un enlace
    mobileLinks.forEach((link) => {
      link.addEventListener("click", () => {
        mobileMenu.classList.add("hidden");
        menuButton.setAttribute("aria-expanded", "false");
        menuIcon?.classList.remove("hidden");
        closeIcon?.classList.add("hidden");
      });
    });

    // Cerrar menú al hacer clic fuera
    document.addEventListener("click", (e) => {
      const target = e.target as Node;
      if (!menuButton.contains(target) && !mobileMenu.contains(target)) {
        mobileMenu.classList.add("hidden");
        menuButton.setAttribute("aria-expanded", "false");
        menuIcon?.classList.remove("hidden");
        closeIcon?.classList.add("hidden");
      }
    });
  }

  // Ejecutar cuando la página carga
  document.addEventListener("astro:page-load", () => {
    initMobileMenu();

    // Intersection Observer para secciones activas
    const sections = document.querySelectorAll("section");
    const navItems = document.querySelectorAll("header nav a");

    const callback = (entries: any[]) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          navItems.forEach((item) => {
            const href = item.getAttribute("href");
            if (href === `#${entry.target.id}`) {
              item.classList.add("text-blue-500");
            } else {
              item.classList.remove("text-blue-500");
            }
          });
        }
      });
    };

    const observer = new IntersectionObserver(callback, {
      root: null,
      rootMargin: "0px",
      threshold: 0.3,
    });

    sections.forEach((section) => {
      observer.observe(section);
    });

    // Cleanup function
    document.onvisibilitychange = () => {
      if (document.visibilityState === "hidden") {
        observer.disconnect();
      } else {
        sections.forEach((section) => {
          observer.observe(section);
        });
      }
    };
  });

  // Backup: ejecutar también cuando el DOM esté listo
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initMobileMenu);
  } else {
    initMobileMenu();
  }
</script>

<style>
  nav {
    animation: nav-shadown 1s linear both;
    animation-timeline: scroll();
    animation-range: 0 100px;
  }

  nav {
    @apply dark:bg-gray-800/90 bg-white/50 rounded-full py-2;
  }

  @keyframes nav-shadown {
    0% {
      @apply dark:bg-gray-800/0 bg-white/0;
    }
    to {
      @apply shadow-lg ring-1 backdrop-blur ring-white/10;
    }
  }

  /* Animación suave del menú */
  #mobile-menu {
    animation: slideDown 0.2s ease-out;
  }

  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>
